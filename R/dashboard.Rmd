---
title: "ğŸ“ˆ Stock Signal Miner"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    runtime: shiny
---

```{r title_ui, echo=FALSE}
div(style = "display: flex; justify-content: flex-end; align-items: top; gap: 10px; margin-bottom: 10px;",
  dateInput("top_date", NULL, value = Sys.Date()),
  actionButton("top_action", "â›ï¸ Mine From Top")
)
```

```{r}
observeEvent(input$top_action, {
  req(input$stock_symbol)

  data <- get_stock_data(
    symbol = input$stock_symbol,
    start_date = input$date_range[1],
    end_date = input$top_date,
    stock_exchange = input$stock_exchange
  )

  features <- generate_features(data)

  stats <- features %>%
    select(-date) %>%
    summarise(across(everything(), list(
      mean = ~round(mean(., na.rm = TRUE), 3),
      sd   = ~round(sd(., na.rm = TRUE), 3)
    )))

  stats_long <- stats %>%
    pivot_longer(everything(),
                 names_to = c("Feature", "Stat"),
                 names_sep = "_(?=[^_]+$)",
                 values_to = "Value") %>% 
    pivot_wider(
      names_from = Stat,
      values_from = Value
    )
  
  rsi <- mean(features$rsi_14, na.rm = TRUE)
  macd <- mean(features$macd - features$signal, na.rm = TRUE)  
  cci <- mean(features$cci_20, na.rm = TRUE)
  suggestions <- c()
  
  if (!is.na(rsi)) {
    if (rsi > 70) {
      suggestions <- c(suggestions, "ğŸ“ˆ RSI is high â†’ Market may be overbought â†’ Consider selling or holding.")
    } else if (rsi < 30) {
      suggestions <- c(suggestions, "ğŸ“‰ RSI is low â†’ Market may be oversold â†’ Could be a buying signal.")
    } else {
      suggestions <- c(suggestions, "ğŸ“Š RSI is neutral â†’ Wait or monitor closely.")
    }
  }
  
  if (!is.na(macd)) {
    if (macd > 0) {
      suggestions <- c(suggestions, "ğŸ’¹ MACD Histogram is positive â†’ Momentum is up.")
    } else if (macd < 0) {
      suggestions <- c(suggestions, "ğŸ”» MACD Histogram is negative â†’ Momentum is down.")
    } else {
      suggestions <- c(suggestions, "âš–ï¸ MACD is neutral â†’ No clear momentum.")
    }
  }
  
  if (!is.na(cci)) {
    if (cci > 100) {
      suggestions <- c(suggestions, "ğŸ“ˆ CCI > 100 â†’ Potentially overbought.")
    } else if (cci < -100) {
      suggestions <- c(suggestions, "ğŸ“‰ CCI < -100 â†’ Potentially oversold.")
    } else {
      suggestions <- c(suggestions, "ğŸ“Š CCI within normal range.")
    }
  }
  
  suggestion <- paste(suggestions, collapse = "<br><br>")

  
  stats_text <- paste0(
    "<table style='width:100%; border-collapse:collapse;'>",
    "<tr style='background:#f2f2f2;'><th style='text-align:left; padding:4px;'>ğŸ“Œ Feature</th><th style='text-align:right; padding:4px;'>Mean</th><th style='text-align:right; padding:4px;'>SD</th></tr>",
    paste0(
      apply(stats_long, 1, function(row) {
        sprintf("<tr><td style='padding:4px;'>%s</td><td style='padding:4px; text-align:right;'>%.3f</td><td style='padding:4px; text-align:right;'>%.3f</td></tr>",
                row["Feature"], as.numeric(row["mean"]), as.numeric(row["sd"]))
      }),
      collapse = ""
    ),
    "</table>"
  )
  
  showModal(modalDialog(
    title = paste("ğŸ“Š Feature Stats for", input$stock_symbol),
    HTML(paste0(
      "<b>ğŸ“… Range:</b> ", input$date_range[1], " to ", input$top_date, "<br><br>",
      "<b>ğŸ“‰ Statistical Summary:</b><br>", stats_text, "<br><br>",
      "<b>ğŸ§  Signal Suggestion:</b><br>", suggestion
    )),
    easyClose = TRUE,
    footer = modalButton("OK ğŸ‘")
  ))
})

```

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(ggplot2)
library(dplyr)
library(randomForest)
library(xgboost)
library(lightgbm)
source("model.R")  
```

Column {.sidebar}
---------------------------------------------------------------------

``` {r}

dateRangeInput("date_range",
               "Select Date Range (Data Fetch)",
               start = "2018-07-01",
               end = "2025-01-01")

dateRangeInput("date_range_view",
               "Select Date Range (View)",
               start = "2022-07-01",
               end = "2025-01-01")

dateInput("date_upto", "Date Upto (For Training)", value = "2022-12-12")

selectInput("model_type", "Model Type", choices = c("rf", "xgb", "lbm"))

textInput("retrain", "Retrain Model", value = FALSE)

textInput("stock_symbol", "Stock Symbol", value = "AAPL")

selectInput("stock_exchange", "Stock Exchange", choices = c("NOT_NEPSE", "NEPSE"))

selectInput("feature_plot", "Select Feature Plot",
            choices = c("Bollinger Bands" = "bbands",
                        "MACD" = "macd",
                        "RSI" = "rsi",
                        "Williams %R" = "willr",
                        "CCI" = "cci"),
            selected = "bbands")

actionButton("run", "Predict/Plot")

```

Column {.tabset .tabset-fade}
---------------------------------------------------------------------
```{r}
tabsetPanel(
  tabPanel("ğŸ“Š Predict", 
    renderPlot({
      input$run   

      isolate({
        date_start <- input$date_range[1]
        date_end <- input$date_range[2]

        date_start_view <- input$date_range_view[1]
        date_end_view <- input$date_range_view[2]

        data <- get_stock_data(
          symbol = input$stock_symbol,
          start_date = date_start,
          end_date = date_end,
          stock_exchange = input$stock_exchange)

        features <- generate_features(data) %>% 
          mutate(direction = factor(ifelse(returns > 0, 1, 0)))

        train_data <- features %>% 
          filter(date <= as.Date(input$date_upto))
        test_data <- features %>% 
          filter(date > as.Date(input$date_upto))

        model_type <- input$model_type

        result <- model_predict(
          features,
          train_data,
          test_data,
          date_start = as.character(date_start_view),
          date_end = as.character(date_end_view),
          model_type = model_type,
          model_name = paste0(as.character(input$model_type), "-", input$stock_symbol),
          retrain = ifelse(input$retrain == "TRUE", TRUE, FALSE)
        )

        result[2]
      })
    })
  ),
  
  tabPanel("ğŸ§® Features",
           renderPlot({
              input$run   
              isolate({
                date_start <- input$date_range[1]
                date_end <- input$date_range[2]
        
                data <- get_stock_data(
                  symbol = input$stock_symbol,
                  start_date = date_start,
                  end_date = date_end,
                  stock_exchange = input$stock_exchange)
        
                features <- generate_features(data)
                plots <- plot_features(features,
                              start_date = input$date_range_view[1],
                              end_date = input$date_range_view[2])
                named_plots <- list(
                  bbands = plots[[1]],
                  macd   = plots[[2]],
                  rsi    = plots[[3]],
                  willr  = plots[[4]],
                  cci    = plots[[5]]
                )
                
                named_plots[[input$feature_plot]]
              })
           })),
  
  tabPanel("Data",
    renderTable({
      input$run
      
      isolate({
        date_start <- input$date_range[1]
        date_end <- input$date_range[2]

        data <- get_stock_data(
          symbol = input$stock_symbol,
          start_date = date_start,
          end_date = date_end,
          stock_exchange = input$stock_exchange)

        features <- generate_features(data)
        head(features, 10)
      })
    })),
  
  
  )
```

