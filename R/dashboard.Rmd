---
title: "ðŸ“ˆ Stock Signal Miner"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(ggplot2)
library(dplyr)
library(randomForest)
library(xgboost)
library(lightgbm)
source("model.R")  
```

Column {.sidebar}
---------------------------------------------------------------------

``` {r}

dateRangeInput("date_range",
               "Select Date Range (Data Fetch)",
               start = "2018-07-01",
               end = "2025-01-01")

dateRangeInput("date_range_view",
               "Select Date Range (View)",
               start = "2022-07-01",
               end = "2025-01-01")

dateInput("date_upto", "Date Upto (For Training)", value = "2022-12-12")

selectInput("model_type", "Model Type", choices = c("rf", "xgb", "lbm"))

textInput("retrain", "Retrain Model", value = FALSE)

textInput("stock_symbol", "Stock Symbol", value = "AAPL")

selectInput("stock_exchange", "Stock Exchange", choices = c("NOT_NEPSE", "NEPSE"))

actionButton("run", "Run Prediction")

```

Column 
---------------------------------------------------------------------
```{r}

renderPlot({
  input$run   
  
  isolate( {
    
      date_start <- input$date_range[1]
      date_end <- input$date_range[2]
      
      date_start_view <- input$date_range_view[1]
      date_end_view <- input$date_range_view[2]
      
      data <- get_stock_data(
        symbol = input$stock_symbol,
        start_date = date_start,
        end_date = date_end,
        stock_exchange = input$stock_exchange)
      
      features <- generate_features(data) %>% 
        mutate(direction = factor(ifelse(returns > 0, 1, 0)))
      
      train_data <- features %>% 
        filter(date <= as.Date(input$date_upto))
      test_data <- features %>% 
        filter(date > as.Date(input$date_upto))
      
      
      model_type <- input$model_type
      
      result <- model_predict(
        features,
        train_data,
        test_data,
        date_start = as.character(date_start_view),
        date_end = as.character(date_end_view),
        model_type = model_type,
        model_name = paste0(as.character(input$model_type), "-", input$stock_symbol),
        retrain = ifelse(input$retrain == "TRUE", TRUE, FALSE)
      )
      
      result[2]
      
    }  )
    
})
```



